
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Aquarium Controller</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f1117;--card:#1a1d28;--accent:#3b82f6;--accent2:#22c55e;--warn:#f59e0b;--danger:#ef4444;--text:#e2e8f0;--muted:#64748b;--border:#2d3348}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.header{background:linear-gradient(135deg,#1e293b,#0f172a);padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10}
.header h1{font-size:1.2rem;font-weight:600}
.header .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:8px}
.dot.on{background:var(--accent2);box-shadow:0 0 8px var(--accent2)}
.dot.off{background:var(--danger);box-shadow:0 0 8px var(--danger)}
.grid{display:grid;grid-template-columns:1fr;gap:12px;padding:12px;max-width:800px;margin:0 auto;padding-bottom:80px}
@media(min-width:600px){.grid{grid-template-columns:1fr 1fr}}
.card{background:var(--card);border-radius:12px;padding:16px;border:1px solid var(--border)}
.card h2{font-size:.85rem;text-transform:uppercase;color:var(--muted);letter-spacing:1px;margin-bottom:12px}
.val{font-size:1.8rem;font-weight:700;color:var(--accent)}
.val.warn{color:var(--warn)}
.val.danger{color:var(--danger)}
.val.ok{color:var(--accent2)}
.row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:.9rem}
.row .label{color:var(--muted)}
.badge{padding:2px 8px;border-radius:6px;font-size:.75rem;font-weight:600}
.badge.on{background:rgba(34,197,94,.15);color:var(--accent2)}
.badge.off{background:rgba(100,116,139,.15);color:var(--muted)}
.badge.alert{background:rgba(239,68,68,.15);color:var(--danger)}
.btn{width:100%;padding:10px;border:none;border-radius:8px;font-weight:600;font-size:.9rem;cursor:pointer;margin-top:6px;transition:all .2s;display:flex;justify-content:center;align-items:center;gap:6px}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:#2563eb}
.btn-danger{background:var(--danger);color:#fff}
.btn-danger:hover{background:#dc2626}
.btn-warn{background:var(--warn);color:#000}
.btn-warn:hover{background:#d97706}
.btn-ok{background:var(--accent2);color:#000}
.btn-ok:hover{background:#16a34a}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-ghost:hover{background:#2d3348}
.btn:disabled{opacity:.5;cursor:not-allowed}
.input-row{display:flex;gap:8px;align-items:center;margin-top:6px}
.input-row input,.input-row select{flex:1;padding:8px;border-radius:6px;border:1px solid var(--border);background:#131620;color:var(--text);font-size:.9rem}
.input-row input:focus,.input-row select:focus{outline:none;border-color:var(--accent)}
.stock-bar{height:6px;border-radius:3px;background:#2d3348;margin-top:4px;overflow:hidden}
.stock-fill{height:100%;border-radius:3px;background:var(--accent2);transition:width .5s}
.stock-fill.low{background:var(--warn)}
.stock-fill.empty{background:var(--danger)}
.time-display{font-size:1rem;color:var(--accent);font-family:monospace}
.emergency-banner{background:rgba(239,68,68,.1);border:2px solid var(--danger);border-radius:12px;padding:16px;text-align:center;display:none;margin:12px auto;max-width:800px;width:calc(100% - 24px)}
.emergency-banner.active{display:block;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
.tabs{position:fixed;bottom:0;left:0;right:0;background:#1a1d28;border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:8px 12px 20px 12px;z-index:20;box-shadow:0 -4px 12px rgba(0,0,0,0.5)}
.tab-btn{background:none;border:none;color:var(--muted);display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;flex:1;padding:8px;transition:all 0.2s;border-radius:8px}
.tab-btn:hover{color:var(--text);background:rgba(255,255,255,0.05)}
.tab-btn.active{color:var(--accent)}
.tab-icon{font-size:1.4rem}
.tab-label{font-size:0.75rem;font-weight:600}
.tab-pane{display:none;animation:fadeIn 0.3s ease}
.tab-pane.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
body.ap-mode .tabs {display:none !important;}
body.ap-mode .tab-pane {display:none !important;}
body.ap-mode #tab-config {display:block !important;}
body.ap-mode #emergencyBanner {display:none !important;}
body.ap-mode .header {pointer-events:none;}
</style>
</head>
<body>
<div class="header">
  <div><span class="dot off" id="wifiDot"></span><h1 style="display:inline">üê† Aquarium Controller</h1></div>
  <span class="time-display" id="sysTime">--:--:--</span>
</div>

<!-- Emergency Banner -->
<div class="emergency-banner" id="emergencyBanner">
  ‚ö†Ô∏è <strong>EMERG√äNCIA</strong> ‚Äî Sensor detectou risco de transbordamento! Parando bombas imediatamente.
</div>

<nav class="tabs">
  <button class="tab-btn active" onclick="switchTab('home')">
    <span class="tab-icon">üè†</span><span class="tab-label">In√≠cio</span>
  </button>
  <button class="tab-btn" onclick="switchTab('agenda')">
    <span class="tab-icon">üìÖ</span><span class="tab-label">Agenda</span>
  </button>
  <button class="tab-btn" onclick="switchTab('ferts')">
    <span class="tab-icon">üß™</span><span class="tab-label">Ferts</span>
  </button>
  <button class="tab-btn" onclick="switchTab('config')">
    <span class="tab-icon">‚öôÔ∏è</span><span class="tab-label">Config</span>
  </button>
</nav>

<!-- TAB: HOME -->
<div id="tab-home" class="tab-pane active">
  <div class="grid">
    <!-- Water Level -->
    <div class="card">
      <h2>üíß N√≠vel da √Ågua</h2>
      <div class="val" id="waterLevel">--</div>
      <div style="font-size:.8rem;color:var(--muted)">cm (dist√¢ncia ultrass√¥nico)</div>
      <div class="row" style="margin-top:8px">
        <span class="label">√ìptico</span>
        <span class="badge off" id="optical">--</span>
      </div>
      <div class="row">
        <span class="label">Boia</span>
        <span class="badge off" id="float">--</span>
      </div>
    </div>

    <!-- TPA Control -->
    <div class="card">
      <h2>üîÑ TPA (Troca Parcial)</h2>
      <div class="row">
        <span class="label">Estado</span>
        <span class="badge off" id="tpaState">IDLE</span>
      </div>
      <div class="row">
        <span class="label">Canister</span>
        <span class="badge off" id="canister">OFF</span>
      </div>
      <button class="btn btn-primary" onclick="api('POST','/api/tpa/start')">‚ñ∂ Iniciar TPA</button>
      <button class="btn btn-danger" onclick="api('POST','/api/tpa/abort')">‚èπ Abortar TPA</button>
    </div>

    <!-- Maintenance -->
    <div class="card" style="grid-column:1/-1">
      <h2>üîß Manuten√ß√£o</h2>
      <div class="row">
        <span class="label">Modo Lota√ß√£o/Limpeza (30 min)</span>
        <span class="badge off" id="maintenance">OFF</span>
      </div>
      <button class="btn btn-warn" onclick="api('POST','/api/maintenance/toggle')">üîß Alternar Manuten√ß√£o</button>
      <button class="btn btn-danger" style="margin-top:8px" onclick="api('POST','/api/emergency/stop')">üö® Parada de Emerg√™ncia</button>
    </div>
  </div>
</div>

<!-- TAB: AGENDA -->
<div id="tab-agenda" class="tab-pane">
  <div class="grid">
    <!-- Schedule -->
    <div class="card" style="grid-column:1/-1">
      <h2>üìÖ Agendamento</h2>
      <div class="row"><span class="label">Hor√°rio da TPA Semanal</span><span id="tpaSched">D- --:--</span></div>
      <div class="input-row">
        <select id="tpaD" style="width:70px"><option value="0">Dom</option><option value="1">Seg</option><option value="2">Ter</option><option value="3">Qua</option><option value="4">Qui</option><option value="5">Sex</option><option value="6">S√°b</option></select>
        <input type="number" id="tpaH" min="0" max="23" placeholder="HH" style="width:55px">
        <span>:</span>
        <input type="number" id="tpaM" min="0" max="59" placeholder="MM" style="width:55px">
        <button class="btn btn-primary" style="width:auto;margin:0;padding:8px 16px" onclick="setSchedule('tpa')">Salvar ‚úî</button>
      </div>
    </div>
  </div>
</div>

<!-- TAB: FERTS -->
<div id="tab-ferts" class="tab-pane">
  <div class="grid">
    <div class="card" style="grid-column:1/-1">
      <h2>üß™ Doses e Estoque</h2>
      <div id="fertCards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px">
      </div>
    </div>
  </div>
</div>

<!-- TAB: CONFIG -->
<div id="tab-config" class="tab-pane">
  <div class="grid">
    <!-- WiFi Config -->
    <div class="card" id="wifiCard" style="grid-column:1/-1">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h2 style="margin:0">üì∂ Configurar WiFi</h2>
        <button class="btn btn-ok" style="width:auto;padding:4px 8px;font-size:0.8rem;margin:0" onclick="scanWiFi(this)" id="btnScan">‚Üª Buscar Redes</button>
      </div>
      <form onsubmit="saveWiFi(event)">
        <div class="input-row" style="margin-bottom:8px">
          <span class="label" style="width:50px">SSID</span>
          <select id="wifiSsid" required style="flex-grow:1;background:var(--bg);color:var(--text);border:1px solid var(--border);padding:8px;border-radius:4px">
            <option value="" disabled selected>Clique em Buscar...</option>
          </select>
        </div>
        <div class="input-row" style="margin-bottom:8px">
          <span class="label" style="width:50px">Senha</span>
          <input type="password" id="wifiPass" required style="flex-grow:1">
        </div>
        <button type="submit" class="btn btn-primary" style="margin-top:8px">üíæ Salvar e Reiniciar Placa</button>
      </form>
    </div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);

function switchTab(tabId) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  document.querySelector(`button[onclick*="'${tabId}'"]`).classList.add('active');
  $(`tab-${tabId}`).classList.add('active');
}

// Build fertilizer cards shell (content will be updated by telemetry)
for(let i=0; i<5; i++) {
  $('fertCards').innerHTML += `
    <div style="background:var(--bg);border-radius:8px;padding:12px;border:1px solid var(--border)">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:.8rem;color:var(--muted);font-weight:600">CANAL ${i+1}</div>
        <div style="font-size:1.4rem;font-weight:700;text-align:right" id="stock${i}">--</div>
      </div>
      <!-- Re-name Input -->
      <div class="input-row" style="margin-top:4px">
        <input type="text" id="nameIn${i}" placeholder="Nome (Ex: Ferro)" style="padding:6px;font-size:.8rem;font-weight:600">
        <button class="btn btn-ghost" style="width:auto;margin:0;padding:6px 12px;font-size:.8rem" onclick="setName(${i})">Salvar</button>
      </div>

      <div class="stock-bar" style="margin:12px 0"><div class="stock-fill" id="bar${i}" style="width:0%"></div></div>
      
      <div style="display:flex;gap:8px">
        <div class="input-row" style="margin:0;flex:1">
          <input type="number" id="dose${i}" step="0.5" min="0" max="100" placeholder="ML/Dose" style="padding:6px;font-size:.8rem;text-align:right">
          <button class="btn btn-primary" style="width:auto;margin:0;padding:6px 10px;font-size:.8rem" onclick="setDose(${i})">Dose a aplicar</button>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;margin-bottom:12px">
        <div class="input-row" style="margin:0;flex:1">
          <input type="number" id="rst${i}" min="0" max="2000" placeholder="Vol Total" style="padding:6px;font-size:.8rem;text-align:right">
          <button class="btn btn-ok" style="width:auto;margin:0;padding:6px 10px;font-size:.8rem" onclick="resetStock(${i})">Reabastecer</button>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid var(--border);margin:12px 0">
      
      <!-- Individual Schedule -->
      <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px">AGENDA (Dias = <span id="sDMask${i}">Todos</span> | <span id="sTimeMask${i}">--:--</span>)</div>
      <div class="input-row" style="margin:0 0 8px 0;flex-wrap:wrap;gap:4px">
        <label style="font-size:.7rem"><input type="checkbox" id="d0_${i}"> D</label>
        <label style="font-size:.7rem"><input type="checkbox" id="d1_${i}"> S</label>
        <label style="font-size:.7rem"><input type="checkbox" id="d2_${i}"> T</label>
        <label style="font-size:.7rem"><input type="checkbox" id="d3_${i}"> Q</label>
        <label style="font-size:.7rem"><input type="checkbox" id="d4_${i}"> Q</label>
        <label style="font-size:.7rem"><input type="checkbox" id="d5_${i}"> S</label>
        <label style="font-size:.7rem"><input type="checkbox" id="d6_${i}"> S</label>
      </div>
      <div class="input-row" style="margin:0">
        <input type="number" id="sH${i}" min="0" max="23" placeholder="HH" style="padding:4px;font-size:.8rem">
        <span style="color:var(--muted)">:</span>
        <input type="number" id="sM${i}" min="0" max="59" placeholder="MM" style="padding:4px;font-size:.8rem">
        <button class="btn btn-ghost" style="width:auto;margin:0;padding:4px 8px;font-size:.75rem" onclick="setFertSched(${i})">Agendar</button>
      </div>

      <hr style="border:0;border-top:1px solid var(--border);margin:12px 0">

      <!-- Calibration -->
      <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px">CALIBRA√á√ÉO (<span id="rateLabel${i}">--</span> mL/s)</div>
      <div style="display:flex;gap:4px;margin-bottom:8px">
        <button class="btn btn-ghost" style="padding:4px;font-size:.75rem;flex:1" onmousedown="pump(${i},1)" onmouseup="pump(${i},0)" ontouchstart="pump(${i},1)" ontouchend="pump(${i},0)">Segure = Purgar</button>
        <button class="btn btn-ghost" style="padding:4px;font-size:.75rem;flex:1" onclick="run3s(${i})">Rodar 3s</button>
      </div>
      <div class="input-row" style="margin:0">
        <input type="number" id="calMl${i}" step="0.1" min="0" placeholder="mL medidos nos 3s" style="padding:4px;font-size:.8rem">
        <button class="btn btn-warn" style="width:auto;margin:0;padding:4px 8px;font-size:.75rem" onclick="saveCalib(${i})">Calcular</button>
      </div>
    </div>`;
}

function api(method, url, body) {
  fetch(url, {method, headers:{'Content-Type':'application/json'}, body: body ? JSON.stringify(body) : undefined})
    .then(r => r.json()).then(d => { if(d.error) alert(d.error); })
    .catch(e => console.error(e));
}

async function saveWiFi(e) {
  e.preventDefault();
  const fd = new URLSearchParams();
  fd.append('ssid', $('wifiSsid').value);
  fd.append('pass', $('wifiPass').value);
  try {
    const r = await fetch('/api/wifi', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:fd });
    if(r.ok) alert('WiFi configurado! O sistema reiniciar√° para conectar.');
    else alert('Erro ao salvar WiFi.');
  } catch(err) { alert('Erro de comunica√ß√£o.'); }
}

async function scanWiFi(btn) {
  btn.textContent = '‚è± Buscando...';
  btn.disabled = true;
  
  const poll = async () => {
    try {
      const r = await fetch('/api/wifi/scan');
      if (r.status === 202) {
        setTimeout(poll, 1500); // Wait and poll again
        return;
      }
      if (r.ok) {
        const d = await r.json();
        const sel = $('wifiSsid');
        sel.innerHTML = '<option value="" disabled selected>Selecione uma rede...</option>';
        if(d.networks.length === 0) sel.innerHTML = '<option value="" disabled>Nenhuma rede encontrada</option>';
        d.networks.forEach(n => {
          const opt = document.createElement('option');
          opt.value = n.ssid;
          opt.textContent = `${n.ssid} (${n.rssi}dBm)`;
          sel.appendChild(opt);
        });
      }
    } catch(err) { alert('Erro ao buscar redes.'); }
    btn.textContent = '‚Üª Buscar';
    btn.disabled = false;
  };
  poll();
}

function setSchedule(type) {
  if (type === 'tpa') {
    api('POST', '/api/schedule', {tpaDay: +$('tpaD').value, tpaHour: +$('tpaH').value, tpaMinute: +$('tpaM').value});
  }
}

function setFertSched(ch) {
  let mask = 0;
  for(let i=0; i<7; i++) {
    if($(`d${i}_${ch}`).checked) mask |= (1 << i);
  }
  const h = +$(`sH${ch}`).value;
  const m = +$(`sM${ch}`).value;
  api('POST', '/api/fert/schedule', {channel: ch, days: mask, hour: h, minute: m});
}

function pump(ch, st) {
  api('POST', '/api/fert/pump', {channel: ch, state: st});
}

function run3s(ch) {
  if(confirm(`Ativar canal ${ch+1} por exatamente 3 segundos? Tenha um recipiente pronto para medir a sa√≠da em mL.`)) {
    api('POST', '/api/fert/run3s', {channel: ch});
  }
}

function saveCalib(ch) {
  const ml = +$(`calMl${ch}`).value;
  if (ml > 0) {
    if(confirm(`Usar ${ml}mL como medida de calibra√ß√£o de 3 segundos no canal ${ch+1}?`)) {
      api('POST', '/api/fert/calibrate', {channel: ch, ml: ml});
      $(`calMl${ch}`).value = ''; // clear input
    }
  } else {
    alert("Insira a quantidade de mL medida.");
  }
}

function setDose(ch) {
  const ml = +$('dose'+ch).value;
  if (ml > 0) api('POST', '/api/dose', {channel: ch, ml: ml});
}

function resetStock(ch) {
  const ml = +$('rst'+ch).value;
  if (ml > 0) api('POST', '/api/stock/reset', {channel: ch, ml: ml});
}

function setName(ch) {
  const name = $('nameIn'+ch).value.trim();
  if (name.length > 0) {
    api('POST', '/api/fert/name', {channel: ch, name: name});
  }
}

function updateUI(d) {
  // AP Mode isolation
  if(d.wifiConnected !== undefined) {
    document.body.className = d.wifiConnected ? '' : 'ap-mode';
  }

  // Time
  if(d.time) $('sysTime').textContent = d.time;

  // Water
  if(d.waterLevel !== undefined) {
    $('waterLevel').textContent = d.waterLevel.toFixed(1);
    $('waterLevel').className = 'val' + (d.waterLevel < 5 ? ' danger' : d.waterLevel < 10 ? ' warn' : '');
  }

  // Sensors
  setBadge('optical', d.optical, 'HIGH', 'low');
  setBadge('float', d.float, 'FULL', 'empty');
  setBadge('canister', d.canister, 'ON', 'OFF');
  setBadge('tpaState', d.tpaState !== 'IDLE', d.tpaState, d.tpaState);
  setBadge('maintenance', d.maintenance, 'ON', 'OFF');

  // Emergency
  const eb = $('emergencyBanner');
  if(d.emergency) { eb.classList.add('active'); } else { eb.classList.remove('active'); }

  // Schedule
  if(d.tpaDay !== undefined) {
    const days = ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
    $('tpaSched').textContent = days[d.tpaDay]+' '+pad(d.tpaHour)+':'+pad(d.tpaMinute);
  }

  // Stocks, Names, Schedules and Calibration
  if(d.stocks) {
    d.stocks.forEach((s, i) => {
      $('stock'+i).textContent = s.stock.toFixed(0) + ' mL';
      
      // Update name input if not active
      const nameInput = $('nameIn'+i);
      if(document.activeElement !== nameInput && s.name) {
        nameInput.value = s.name;
      }
      
      // Update schedule display strings
      $('sTimeMask'+i).textContent = pad(s.sH)+':'+pad(s.sM);
      const dmask = s.sD;
      let dstr = [];
      const ds = ['D','S','T','Q','Q','S','S'];
      for(let j=0; j<7; j++) {
        if (dmask & (1<<j)) dstr.push(ds[j]);
      }
      $('sDMask'+i).textContent = dmask === 127 ? 'Todos' : (dstr.length > 0 ? dstr.join('-') : 'Nenhum');

      // Update Rate Configs
      if(s.fR !== undefined) $('rateLabel'+i).textContent = s.fR.toFixed(2);

      const pct = Math.min(100, (s.stock / 500) * 100);
      const bar = $('bar'+i);
      bar.style.width = pct + '%';
      bar.className = 'stock-fill' + (pct < 10 ? ' empty' : pct < 20 ? ' low' : '');
    });
  }

  // WiFi indicator
  $('wifiDot').className = 'dot on';
}

function setBadge(id, cond, onText, offText) {
  const el = $(id);
  if(el && cond !== undefined) {
    el.textContent = cond ? onText : offText;
    el.className = 'badge ' + (cond ? 'on' : 'off');
  }
}

function pad(n) { return String(n).padStart(2, '0'); }

// SSE for real-time updates
const evtSource = new EventSource('/events');
evtSource.addEventListener('status', e => {
  try { updateUI(JSON.parse(e.data)); } catch(err) { console.error(err); }
});
evtSource.onerror = () => { $('wifiDot').className = 'dot off'; };

// Initial fetch
fetch('/api/status').then(r=>r.json()).then(updateUI).catch(()=>{});
</script>
</body>
</html>
